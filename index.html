<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P6 Relationship Corrector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- NEW: AWS SDK for S3 v3 - for high-speed multipart uploads -->
    <script src="https://sdk.amazonaws.com/v3/release/aws-sdk.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .custom-file-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .table-container {
            max-height: 40vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-8 space-y-8">

        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-xer" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-blue-500 text-blue-600">
                    XER Corrector
                </button>
                <button id="tab-xml" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    XML Corrector
                </button>
            </nav>
        </div>

        <!-- XER Tab -->
        <div id="content-xer" class="tab-content active">
            <div class="space-y-6">
                <div class="text-center">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">P6 XER Relationship Corrector</h1>
                    <p class="text-gray-600 mt-1">Upload your Primavera P6 XER file to automatically fix out-of-sequence logic.</p>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center justify-center w-full">
                        <label for="file-upload-xer" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-500">Primavera P6 XER file</p>
                            </div>
                            <input id="file-upload-xer" type="file" class="hidden" accept=".xer" />
                        </label>
                    </div>
                    <p id="file-name-xer" class="text-center text-sm text-gray-500">No file selected</p>
                     <!-- Progress Bar -->
                    <div id="progress-container-xer" class="w-full bg-gray-200 rounded-full h-2.5 hidden">
                        <div id="progress-bar-xer" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-in-out" style="width: 0%"></div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="process-btn-xer" class="w-full sm:w-auto flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 custom-file-button" disabled>Process File</button>
                    <button id="download-btn-xer" class="w-full sm:w-auto flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400 custom-file-button" disabled>Download Corrected File</button>
                </div>
                <div id="spinner-xer" class="hidden w-8 h-8 mx-auto spinner rounded-full border-4 border-gray-200"></div>
                <div id="results-container-xer" class="space-y-4 hidden">
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Processing Log</h3>
                        <div id="log-xer" class="mt-2 p-3 bg-gray-900 text-white text-sm font-mono rounded-md h-32 overflow-y-auto"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Modified Relationships</h3>
                        <div class="table-container mt-2 border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Predecessor ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Successor ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-xer" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                         <p id="no-results-message-xer" class="text-center py-4 text-gray-500 hidden">No relationships required modification.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- XML Tab -->
        <div id="content-xml" class="tab-content">
             <div class="space-y-6">
                <div class="text-center">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">P6 XML Relationship Corrector</h1>
                    <p class="text-gray-600 mt-1">Upload a P6 XML file to automatically correct relationship types based on activity status.</p>
                </div>
                <div class="space-y-4">
                     <div class="flex items-center justify-center w-full">
                        <label for="file-upload-xml" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-500">Primavera P6 XML file</p>
                            </div>
                            <input id="file-upload-xml" type="file" class="hidden" accept=".xml" />
                        </label>
                    </div>
                    <p id="file-name-xml" class="text-center text-sm text-gray-500">No file selected</p>
                    <!-- Progress Bar -->
                    <div id="progress-container-xml" class="w-full bg-gray-200 rounded-full h-2.5 hidden">
                        <div id="progress-bar-xml" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-in-out" style="width: 0%"></div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="process-btn-xml" class="w-full sm:w-auto flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 custom-file-button" disabled>Process File</button>
                    <button id="download-btn-xml" class="w-full sm:w-auto flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400 custom-file-button" disabled>Download Corrected File</button>
                </div>
                <div id="spinner-xml" class="hidden w-8 h-8 mx-auto spinner rounded-full border-4 border-gray-200"></div>
                <div id="results-container-xml" class="space-y-4 hidden">
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Processing Log</h3>
                        <div id="log-xml" class="mt-2 p-3 bg-gray-900 text-white text-sm font-mono rounded-md h-32 overflow-y-auto"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800">Modified Relationships</h3>
                        <div class="table-container mt-2 border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Predecessor ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Successor ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-xml" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                         <p id="no-results-message-xml" class="text-center py-4 text-gray-500 hidden">No relationships required modification.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- IMPORTANT: Use the API Gateway endpoint for your Lambda function ---
    const API_ENDPOINT = 'https://qi698s922h.execute-api.us-east-1.amazonaws.com/default/p6Corrector-v3'; 

    const tabXer = document.getElementById('tab-xer');
    const tabXml = document.getElementById('tab-xml');
    const contentXer = document.getElementById('content-xer');
    const contentXml = document.getElementById('content-xml');

    function switchTab(activeTab) {
        contentXer.classList.toggle('active', activeTab === 'xer');
        contentXml.classList.toggle('active', activeTab === 'xml');
        tabXer.classList.toggle('border-blue-500', activeTab === 'xer');
        tabXer.classList.toggle('text-blue-600', activeTab === 'xer');
        tabXer.classList.toggle('border-transparent', activeTab !== 'xer');
        tabXer.classList.toggle('text-gray-500', activeTab !== 'xer');
        tabXml.classList.toggle('border-blue-500', activeTab === 'xml');
        tabXml.classList.toggle('text-blue-600', activeTab === 'xml');
        tabXml.classList.toggle('border-transparent', activeTab !== 'xml');
        tabXml.classList.toggle('text-gray-500', activeTab !== 'xml');
    }
    tabXer.addEventListener('click', () => switchTab('xer'));
    tabXml.addEventListener('click', () => switchTab('xml'));

    function setupCorrector(type) {
        const fileUpload = document.getElementById(`file-upload-${type}`);
        const fileNameDisplay = document.getElementById(`file-name-${type}`);
        const processBtn = document.getElementById(`process-btn-${type}`);
        const downloadBtn = document.getElementById(`download-btn-${type}`);
        const logDiv = document.getElementById(`log-${type}`);
        const resultsTable = document.getElementById(`results-table-${type}`);
        const resultsContainer = document.getElementById(`results-container-${type}`);
        const spinner = document.getElementById(`spinner-${type}`);
        const noResultsMessage = document.getElementById(`no-results-message-${type}`);
        const progressBar = document.getElementById(`progress-bar-${type}`);
        const progressContainer = document.getElementById(`progress-container-${type}`);

        let selectedFile = null;
        let downloadUrl = '';
        let modifiedFileName = '';
        let processingInterval = null;

        fileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            selectedFile = file;
            modifiedFileName = file.name.replace(`.${type}`, `_modified.${type}`);
            fileNameDisplay.textContent = file.name;
            processBtn.disabled = false;
            resetUI();
            log('File selected. Ready to process.');
        });

        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            resetUI();
            log('Requesting secure upload link...');
            processBtn.disabled = true;
            spinner.classList.remove('hidden');
            resultsContainer.classList.remove('hidden');
            progressContainer.classList.remove('hidden');

            try {
                // --- MODIFICATION START: Improved Error Handling ---
                // Helper function to handle fetch errors gracefully
                const handleFetchError = async (response) => {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const err = await response.json();
                        throw new Error(err.message || `Server error: ${response.status}`);
                    } else {
                        const textError = await response.text();
                        throw new Error(`Server error: ${response.status} - ${textError}`);
                    }
                };
                // --- MODIFICATION END ---

                // --- STEP 1: Get a presigned URL from Lambda ---
                const getUrlResponse = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'getUploadUrl',
                        fileName: selectedFile.name,
                        fileType: type,
                    }),
                });
                if (!getUrlResponse.ok) {
                    await handleFetchError(getUrlResponse);
                }
                const { uploadUrl, s3Key } = await getUrlResponse.json();
                
                log('Secure link received. Uploading file directly to S3...', 'success');

                // --- STEP 2: Upload the file directly to S3 with the high-speed uploader ---
                const { Upload } = AWS.S3.Upload;
                const s3 = new AWS.S3.S3Client({ region: "us-east-1", credentials: { accessKeyId: "dummy", secretAccessKey: "dummy" } }); // Credentials are not needed for presigned URL
                
                const parallelUploads3 = new Upload({
                    client: s3,
                    params: {
                        Bucket: 'scheulingprogramsdatabase', // This is just a placeholder, the URL contains the real one
                        Key: s3Key,
                        Body: selectedFile,
                    },
                    queueSize: 4, // Upload 4 parts at a time
                    partSize: 1024 * 1024 * 5, // 5 MB parts
                });

                parallelUploads3.on("httpUploadProgress", (progress) => {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    progressBar.style.width = (percent / 2) + '%'; // Scale progress to 0-50 range
                });

                await parallelUploads3.done();
                log('File uploaded successfully! Now processing...', 'success');
                progressBar.style.width = '50%';


                // --- STEP 2.5: Simulate processing progress (50% -> 95%) ---
                let currentProgress = 50;
                processingInterval = setInterval(() => {
                    currentProgress += 1;
                    if (currentProgress <= 95) {
                        progressBar.style.width = currentProgress + '%';
                    } else {
                        clearInterval(processingInterval);
                    }
                }, 200);

                // --- STEP 3: Tell Lambda to process the file from S3 ---
                const processResponse = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'processFile',
                        s3Key: s3Key,
                        fileType: type,
                    }),
                });
                if (!processResponse.ok) {
                    await handleFetchError(processResponse);
                }
                
                const result = await processResponse.json();
                
                // --- STEP 4: Display the results ---
                clearInterval(processingInterval);
                progressBar.style.width = '100%';

                logDiv.innerHTML = result.logs.map(l => `<p class="whitespace-pre-wrap ${l.color || 'text-white'}">> ${l.message}</p>`).join('');
                
                if (result.resultsTable && result.resultsTable.length > 0) {
                    resultsTable.innerHTML = result.resultsTable.map(row => 
                        `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${row.actionColor}">${row.action}</td><td class="px-6 py-4 whitespace-nowrap text-sm">${row.predCode}</td><td class="px-6 py-4 whitespace-nowrap text-sm">${row.succCode}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.details}</td></tr>`
                    ).join('');
                } else {
                    noResultsMessage.classList.remove('hidden');
                }

                if (result.downloadUrl) {
                    downloadUrl = result.downloadUrl;
                    downloadBtn.disabled = false;
                    log('Processing complete. Corrected file is ready for download.', 'success');
                } else {
                    log('Processing complete. No changes were necessary.');
                }

            } catch (error) {
                log(`An error occurred: ${error.message}`, 'error');
                console.error(error);
                if (processingInterval) clearInterval(processingInterval);
                progressBar.style.backgroundColor = '#ef4444';
            } finally {
                spinner.classList.add('hidden');
                processBtn.disabled = false;
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (!downloadUrl) {
                log('No download URL available.', 'error');
                return;
            }
            window.open(downloadUrl, '_blank');
            log('Download initiated.', 'success');
        });

        function resetUI() {
            resultsContainer.classList.add('hidden');
            resultsTable.innerHTML = '';
            downloadBtn.disabled = true;
            downloadUrl = '';
            logDiv.innerHTML = '';
            noResultsMessage.classList.add('hidden');
            if (progressContainer) progressContainer.classList.add('hidden');
            if (progressBar) {
                progressBar.style.width = '0%';
                progressBar.style.backgroundColor = '#2563eb';
            }
            if (processingInterval) clearInterval(processingInterval);
        }

        function log(message, type = 'info') {
            const colorMap = { 'info': 'text-white', 'error': 'text-red-400', 'success': 'text-green-400', 'cyan': 'text-cyan-400' };
            logDiv.innerHTML += `<p class="whitespace-pre-wrap ${colorMap[type] || 'text-white'}">> ${message}</p>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    }

    setupCorrector('xer');
    setupCorrector('xml');
</script>

</body>
</html>
